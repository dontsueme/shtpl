#!/bin/sh
# Author: Stefan Giermair (zstegi@gmail.com)
# License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>.
# This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law.

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
  printf "\n  %s\n\n  %s\n  %s\n  %s\n\n  %s\n\n"\
  "tinytpl - a tiny shell template engine"\
  "'#%' starts a shell-line (tested: bash and busybox' ash)"\
  "'#%include file'"\
  "'#slurp' removes newline"\
  "to execute type: sh -c \"\$( tinytpl template )\""
  exit 0
fi

tinytpl() {
  FILE="$1"
  IFS=
  while read -r 'LINE'; do  
    if printf "%s" "$LINE" | grep -q "^#%include "; then
      tinytpl "$( printf "%s" "$LINE" | sed s/"^#%include "//  )"
      continue
    elif printf "%s" "$LINE" | grep -q "^#%"; then
      printf "%s\n" "$( printf "%s" "$LINE" | sed s/"^#%"// )"
      continue
    fi

    # dangerous signs are:  \, ", $(, Â´ 
    LINE="$( printf "%s" "$LINE" | sed s/"\\\\"/"\\\\\\\\"/g | \
                                   sed s/'"'/'\\"'/g | \
                                   sed s/'$('/'\\$('/g | \
                                   sed s/'`'/'\\`'/g )"

    if printf "%s" "$LINE" | grep -q "#slurp$"; then
      LINE="$( printf "%s" "$LINE" | sed s/"#slurp$"// )"
      printf "%s\n" "printf \"%s\" \"$LINE\""
    else 
      printf "%s\n" "printf \"%s\\n\" \"$LINE\""
    fi
  done < "$FILE"
}

tinytpl "$1"
